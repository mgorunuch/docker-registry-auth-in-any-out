services:
  registry:
    image: registry:2
    expose:
      - "5000"
    environment:
      REGISTRY_AUTH: token
      REGISTRY_AUTH_TOKEN_REALM: https://docker-registry.the-ihor.com/auth
      REGISTRY_AUTH_TOKEN_SERVICE: docker-registry.the-ihor.com
      REGISTRY_AUTH_TOKEN_ISSUER: docker-auth
      REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE: /certs/server.crt
    volumes:
      - registry-data:/var/lib/registry
      - ./certs:/certs:ro
    restart: unless-stopped

  auth:
    image: cesanta/docker_auth:1
    expose:
      - "5001"
    volumes:
      - ./auth_config.yml:/config/auth_config.yml:ro
      - ./certs:/certs:ro
      - ./auth:/auth:ro
    command: /config/auth_config.yml
    restart: unless-stopped

  proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    expose:
      - "80"
    depends_on:
      - registry
      - auth
    restart: unless-stopped

volumes:
  registry-data:
